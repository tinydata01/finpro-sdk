/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, Input, Output, EventEmitter, ViewChildren } from '@angular/core';
import { FormGroup, FormControl } from '@angular/forms';
import { KeysPipe } from '../pipes/keys.pipe';
import { Setting } from '../models/setting';
import { CounterDirective } from '../directives/timer.directive';
export class OtpInputComponent {
    /**
     * @param {?} keysPipe
     */
    constructor(keysPipe) {
        this.keysPipe = keysPipe;
        this.setting = {
            length: 4,
            timer: 0
        };
        this.onValueChange = new EventEmitter();
        this.inputControls = new Array(this.setting.length);
        this.componentKey = Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36);
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.otpForm = new FormGroup({});
        for (let index = 0; index < this.setting.length; index++) {
            this.otpForm.addControl(this.getControlName(index), new FormControl());
        }
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        /** @type {?} */
        let containerItem = document.getElementById(`c_${this.componentKey}`);
        if (containerItem) {
            /** @type {?} */
            let ele = containerItem.getElementsByClassName('.otp-input')[0];
            if (ele && ele.focus) {
                ele.focus();
            }
        }
    }
    /**
     * @private
     * @param {?} idx
     * @return {?}
     */
    getControlName(idx) {
        return `ctrl_${idx}`;
    }
    /**
     * @param {?} e
     * @return {?}
     */
    isLeftArrow(e) {
        return this.isKeyCode(e, 37);
    }
    /**
     * @param {?} e
     * @return {?}
     */
    isRightArrow(e) {
        return this.isKeyCode(e, 39);
    }
    /**
     * @param {?} e
     * @return {?}
     */
    isBackspaceOrDelete(e) {
        return e.key === "Backspace" || e.key === "Delete" || this.isKeyCode(e, 8) || this.isKeyCode(e, 46);
    }
    /**
     * @param {?} e
     * @param {?} targetCode
     * @return {?}
     */
    isKeyCode(e, targetCode) {
        /** @type {?} */
        var key = e.keyCode || e.charCode;
        if (key == targetCode) {
            return true;
        }
        return false;
    }
    /**
     * @param {?} e
     * @param {?} inputIdx
     * @return {?}
     */
    keyUp(e, inputIdx) {
        /** @type {?} */
        let nextInputId = this.appendKey(`otp_${inputIdx + 1}`);
        /** @type {?} */
        let prevInputId = this.appendKey(`otp_${inputIdx - 1}`);
        if (this.isRightArrow(e)) {
            this.setSelected(nextInputId);
            return;
        }
        if (this.isLeftArrow(e)) {
            this.setSelected(prevInputId);
            return;
        }
        /** @type {?} */
        let isBackspace = this.isBackspaceOrDelete(e);
        if (isBackspace && !e.target.value) {
            this.setSelected(prevInputId);
            this.rebuildValue();
            return;
        }
        if (!e.target.value) {
            return;
        }
        if (this.isValidEntry(e)) {
            this.focusTo(nextInputId);
        }
        this.rebuildValue();
    }
    /**
     * @param {?} id
     * @return {?}
     */
    appendKey(id) {
        return `${id}_${this.componentKey}`;
    }
    /**
     * @param {?} eleId
     * @return {?}
     */
    setSelected(eleId) {
        this.focusTo(eleId);
        /** @type {?} */
        let ele = document.getElementById(eleId);
        if (ele && ele.setSelectionRange) {
            setTimeout((/**
             * @return {?}
             */
            () => {
                ele.setSelectionRange(0, 1);
            }), 0);
        }
    }
    /**
     * @param {?} e
     * @return {?}
     */
    isValidEntry(e) {
        /** @type {?} */
        var inp = String.fromCharCode(e.keyCode);
        /** @type {?} */
        var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        return isMobile || /[a-zA-Z0-9-_]/.test(inp) || (this.setting.allowKeyCodes && this.setting.allowKeyCodes.includes(e.keyCode)) || (e.keyCode >= 96 && e.keyCode <= 105);
    }
    /**
     * @param {?} eleId
     * @return {?}
     */
    focusTo(eleId) {
        /** @type {?} */
        let ele = document.getElementById(eleId);
        if (ele) {
            ele.focus();
            ele.selectionStart = ele.selectionEnd = 100;
        }
    }
    /**
     * @return {?}
     */
    rebuildValue() {
        /** @type {?} */
        let val = '';
        this.keysPipe.transform(this.otpForm.controls).forEach((/**
         * @param {?} k
         * @return {?}
         */
        k => {
            if (this.otpForm.controls[k].value) {
                val += this.otpForm.controls[k].value;
            }
        }));
        this.onValueChange.emit(val);
    }
    /**
     * @param {?} e
     * @return {?}
     */
    onCounterChange(e) {
        this.counter = e;
        if (this.counter == 0) {
            this.onValueChange.emit(-1);
        }
    }
    /**
     * @return {?}
     */
    ressendOtp() {
        this.CounterDirective.first.startTimer();
        this.onValueChange.emit(-2);
    }
}
OtpInputComponent.decorators = [
    { type: Component, args: [{
                selector: 'otp',
                template: "<div class=\"otp-container {{setting.wrapperClass}}\" id=\"c_{{componentKey}}\" *ngIf=\"otpForm?.controls\"\n    [ngStyle]=\"setting.wrapperStyles\">\n    <input \n        [type]=\"setting.numbersOnly ? 'tel' : 'text'\" \n        numberOnly [disabledNumberOnly]=\"!setting.numbersOnly\"\n        [ngStyle]=\"setting.inputStyles\" \n        maxlength=\"1\" \n        class=\"otp-input {{setting.inputClass}}\" \n        autocomplete=\"off\"\n        *ngFor=\"let item of otpForm?.controls | keys; let i = index\" \n        [formControl]=\"otpForm.controls[item]\"\n        id=\"otp_{{i}}_{{componentKey}}\" \n        (keyup)=\"keyUp($event, i)\"\n    >\n    <ng-container counter [counter]=\"setting.timer\" (value)=\"onCounterChange($event)\">\n        <div>\n            <button class=\"btn {{setting.btnClass}}\" [disabled]=\"counter != 0\" (click)=\"ressendOtp()\">\n                Resend OTP <span *ngIf=\"counter != 0\">in {{ counter }} seconds.</span>\n            </button>\n        </div>\n    </ng-container>\n</div>",
                styles: [".otp-input{width:2em;height:2em;border-radius:4px;border:1px solid #c5c5c5;text-align:center;font-size:28px}.otp-input:focus{outline-offset:0;outline:#2b91e2 auto 5px}.otp-container .otp-input:not(:last-child){margin-right:8px}@media screen and (max-width:767px){.otp-input{font-size:24px}}@media screen and (max-width:420px){.otp-input{font-size:18px}}"]
            }] }
];
/** @nocollapse */
OtpInputComponent.ctorParameters = () => [
    { type: KeysPipe }
];
OtpInputComponent.propDecorators = {
    setting: [{ type: Input }],
    onValueChange: [{ type: Output }],
    CounterDirective: [{ type: ViewChildren, args: [CounterDirective,] }]
};
if (false) {
    /** @type {?} */
    OtpInputComponent.prototype.setting;
    /** @type {?} */
    OtpInputComponent.prototype.onValueChange;
    /** @type {?} */
    OtpInputComponent.prototype.CounterDirective;
    /** @type {?} */
    OtpInputComponent.prototype.otpForm;
    /** @type {?} */
    OtpInputComponent.prototype.inputControls;
    /** @type {?} */
    OtpInputComponent.prototype.componentKey;
    /** @type {?} */
    OtpInputComponent.prototype.counter;
    /**
     * @type {?}
     * @private
     */
    OtpInputComponent.prototype.keysPipe;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci1vdHAtaW5wdXQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhci1vdHAtYm94LyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvYW5ndWxhci1vdHAtaW5wdXQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLEtBQUssRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RixPQUFPLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDNUMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFRakUsTUFBTSxPQUFPLGlCQUFpQjs7OztJQVk3QixZQUFvQixRQUFrQjtRQUFsQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBWDdCLFlBQU8sR0FBWTtZQUMzQixNQUFNLEVBQUUsQ0FBQztZQUNULEtBQUssRUFBRSxDQUFDO1NBQ1IsQ0FBQztRQUNRLGtCQUFhLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUdsRCxrQkFBYSxHQUFrQixJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzlELGlCQUFZLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBR3BELENBQUM7Ozs7SUFFbkMsUUFBUTtRQUNkLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxT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RTs7SUFDRiwwQ0FBa0Q7O0lBQ2xELDZDQUFpRDs7SUFDakQsb0NBQW1COztJQUNuQiwwQ0FBOEQ7O0lBQzlELHlDQUE2Rjs7SUFDN0Ysb0NBQXVCOzs7OztJQUVYLHFDQUEwQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0LCBJbnB1dCwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIFZpZXdDaGlsZHJlbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRm9ybUdyb3VwLCBGb3JtQ29udHJvbCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IEtleXNQaXBlIH0gZnJvbSAnLi4vcGlwZXMva2V5cy5waXBlJztcbmltcG9ydCB7IFNldHRpbmcgfSBmcm9tICcuLi9tb2RlbHMvc2V0dGluZyc7XG5pbXBvcnQgeyBDb3VudGVyRGlyZWN0aXZlIH0gZnJvbSAnLi4vZGlyZWN0aXZlcy90aW1lci5kaXJlY3RpdmUnO1xuXG5AQ29tcG9uZW50KHtcblx0c2VsZWN0b3I6ICdvdHAnLFxuXHR0ZW1wbGF0ZVVybDogJy4vYW5ndWxhci1vdHAtaW5wdXQuY29tcG9uZW50Lmh0bWwnLFxuXHRzdHlsZVVybHM6IFsnLi9hbmd1bGFyLW90cC1pbnB1dC5jb21wb25lbnQuc2NzcyddXG59KVxuXG5leHBvcnQgY2xhc3MgT3RwSW5wdXRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuXHRASW5wdXQoKSBzZXR0aW5nOiBTZXR0aW5nID0geyBcblx0XHRsZW5ndGg6IDQsIFxuXHRcdHRpbWVyOiAwXG5cdH07XG5cdEBPdXRwdXQoKSBvblZhbHVlQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cdEBWaWV3Q2hpbGRyZW4oQ291bnRlckRpcmVjdGl2ZSkgQ291bnRlckRpcmVjdGl2ZTtcblx0b3RwRm9ybTogRm9ybUdyb3VwO1xuXHRpbnB1dENvbnRyb2xzOiBGb3JtQ29udHJvbFtdID0gbmV3IEFycmF5KHRoaXMuc2V0dGluZy5sZW5ndGgpO1xuXHRjb21wb25lbnRLZXkgPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHJpbmcoMikgKyAobmV3IERhdGUoKSkuZ2V0VGltZSgpLnRvU3RyaW5nKDM2KTtcblx0cHVibGljIGNvdW50ZXI6IG51bWJlcjtcblx0XG5cdGNvbnN0cnVjdG9yKHByaXZhdGUga2V5c1BpcGU6IEtleXNQaXBlKSB7fVxuXG5cdHB1YmxpYyBuZ09uSW5pdCgpOiB2b2lkIHtcblx0XHR0aGlzLm90cEZvcm0gPSBuZXcgRm9ybUdyb3VwKHt9KVxuXHRcdGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB0aGlzLnNldHRpbmcubGVuZ3RoOyBpbmRleCsrKSB7XG5cdFx0XHR0aGlzLm90cEZvcm0uYWRkQ29udHJvbCh0aGlzLmdldENvbnRyb2xOYW1lKGluZGV4KSwgbmV3IEZvcm1Db250cm9sKCkpXG5cdFx0fVxuXHR9XG5cdFxuXHRwdWJsaWMgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xuXHRcdGxldCBjb250YWluZXJJdGVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYGNfJHt0aGlzLmNvbXBvbmVudEtleX1gKTtcblx0XHRpZiAoY29udGFpbmVySXRlbSkge1xuXHRcdFx0bGV0IGVsZTogYW55ID0gY29udGFpbmVySXRlbS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCcub3RwLWlucHV0JylbMF1cblx0XHRcdGlmIChlbGUgJiYgZWxlLmZvY3VzKSB7XG5cdFx0XHRcdGVsZS5mb2N1cygpO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgZ2V0Q29udHJvbE5hbWUoaWR4KSB7XG5cdFx0cmV0dXJuIGBjdHJsXyR7aWR4fWA7XG5cdH1cblxuXHRpc0xlZnRBcnJvdyhlKSB7XG5cdFx0cmV0dXJuIHRoaXMuaXNLZXlDb2RlKGUsIDM3KTtcblx0fVxuXG5cdGlzUmlnaHRBcnJvdyhlKSB7XG5cdFx0cmV0dXJuIHRoaXMuaXNLZXlDb2RlKGUsIDM5KTtcblx0fVxuXG5cdGlzQmFja3NwYWNlT3JEZWxldGUoZSkge1xuXHRcdHJldHVybiBlLmtleSA9PT0gXCJCYWNrc3BhY2VcIiB8fCBlLmtleSA9PT0gXCJEZWxldGVcIiB8fCB0aGlzLmlzS2V5Q29kZShlLCA4KSB8fCB0aGlzLmlzS2V5Q29kZShlLCA0Nik7XG5cdH1cblxuXHRpc0tleUNvZGUoZSwgdGFyZ2V0Q29kZSkge1xuXHRcdHZhciBrZXkgPSBlLmtleUNvZGUgfHwgZS5jaGFyQ29kZTtcblx0XHRpZihrZXkgPT0gdGFyZ2V0Q29kZSkgeyByZXR1cm4gdHJ1ZTsgfVxuXHRcdHJldHVybiBmYWxzZTtcblx0fVxuXG5cdGtleVVwKGUsIGlucHV0SWR4OiBudW1iZXIpIHtcblx0XHRsZXQgbmV4dElucHV0SWQgPSB0aGlzLmFwcGVuZEtleShgb3RwXyR7aW5wdXRJZHggKyAxfWApO1xuXHRcdGxldCBwcmV2SW5wdXRJZCA9IHRoaXMuYXBwZW5kS2V5KGBvdHBfJHtpbnB1dElkeCAtIDF9YCk7XG5cdFx0aWYgKHRoaXMuaXNSaWdodEFycm93KGUpKSB7XG5cdFx0XHR0aGlzLnNldFNlbGVjdGVkKG5leHRJbnB1dElkKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0aWYgKHRoaXMuaXNMZWZ0QXJyb3coZSkpIHtcblx0XHRcdHRoaXMuc2V0U2VsZWN0ZWQocHJldklucHV0SWQpO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblx0XHRsZXQgaXNCYWNrc3BhY2UgPSB0aGlzLmlzQmFja3NwYWNlT3JEZWxldGUoZSk7XG5cdFx0aWYgKGlzQmFja3NwYWNlICYmICFlLnRhcmdldC52YWx1ZSkge1xuXHRcdFx0dGhpcy5zZXRTZWxlY3RlZChwcmV2SW5wdXRJZCk7XG5cdFx0XHR0aGlzLnJlYnVpbGRWYWx1ZSgpO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblx0XHRpZiAoIWUudGFyZ2V0LnZhbHVlKSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXHRcdGlmICh0aGlzLmlzVmFsaWRFbnRyeShlKSkge1xuXHRcdFx0dGhpcy5mb2N1c1RvKG5leHRJbnB1dElkKTtcblx0XHR9XG5cdFx0dGhpcy5yZWJ1aWxkVmFsdWUoKTtcblx0fVxuXG5cdGFwcGVuZEtleShpZCkge1xuXHRcdHJldHVybiBgJHtpZH1fJHt0aGlzLmNvbXBvbmVudEtleX1gO1xuXHR9XG5cblx0c2V0U2VsZWN0ZWQoZWxlSWQpIHtcblx0XHR0aGlzLmZvY3VzVG8oZWxlSWQpO1xuXHRcdGxldCBlbGU6IGFueSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGVsZUlkKTtcblx0XHRpZiAoZWxlICYmIGVsZS5zZXRTZWxlY3Rpb25SYW5nZSkge1xuXHRcdFx0c2V0VGltZW91dCgoKSA9PiB7XG5cdFx0XHRcdGVsZS5zZXRTZWxlY3Rpb25SYW5nZSgwLCAxKTtcblx0XHRcdH0sIDApO1xuXHRcdH1cblx0fVxuXG5cdGlzVmFsaWRFbnRyeShlKSB7XG5cdFx0dmFyIGlucCA9IFN0cmluZy5mcm9tQ2hhckNvZGUoZS5rZXlDb2RlKTtcblx0XHR2YXIgaXNNb2JpbGUgPSAvaVBob25lfGlQYWR8aVBvZHxBbmRyb2lkL2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KTtcblx0XHRyZXR1cm4gaXNNb2JpbGUgfHwgL1thLXpBLVowLTktX10vLnRlc3QoaW5wKSB8fCAodGhpcy5zZXR0aW5nLmFsbG93S2V5Q29kZXMgJiYgdGhpcy5zZXR0aW5nLmFsbG93S2V5Q29kZXMuaW5jbHVkZXMoZS5rZXlDb2RlKSkgfHwgKGUua2V5Q29kZSA+PSA5NiAmJiBlLmtleUNvZGUgPD0gMTA1KTtcblx0fVxuXG5cdGZvY3VzVG8oZWxlSWQpIHtcblx0XHRsZXQgZWxlOiBhbnkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChlbGVJZCk7XG5cdFx0aWYgKGVsZSkge1xuXHRcdFx0ZWxlLmZvY3VzKCk7XG5cdFx0XHRlbGUuc2VsZWN0aW9uU3RhcnQgPSBlbGUuc2VsZWN0aW9uRW5kID0gMTAwO1xuXHRcdH1cblx0fVxuXG5cdHJlYnVpbGRWYWx1ZSgpIHtcblx0XHRsZXQgdmFsID0gJyc7XG5cdFx0dGhpcy5rZXlzUGlwZS50cmFuc2Zvcm0odGhpcy5vdHBGb3JtLmNvbnRyb2xzKS5mb3JFYWNoKGsgPT4ge1xuXHRcdFx0aWYgKHRoaXMub3RwRm9ybS5jb250cm9sc1trXS52YWx1ZSkge1xuXHRcdFx0XHR2YWwgKz0gdGhpcy5vdHBGb3JtLmNvbnRyb2xzW2tdLnZhbHVlO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHRcdHRoaXMub25WYWx1ZUNoYW5nZS5lbWl0KHZhbCk7XG5cdH1cblxuXHRwdWJsaWMgb25Db3VudGVyQ2hhbmdlKGUpOiB2b2lkIHtcblx0XHR0aGlzLmNvdW50ZXIgPSBlO1xuXHRcdGlmKHRoaXMuY291bnRlciA9PSAwKSB7XG5cdFx0XHR0aGlzLm9uVmFsdWVDaGFuZ2UuZW1pdCgtMSk7XG5cdFx0fVxuXHR9XG5cblx0cmVzc2VuZE90cCgpOiB2b2lkIHtcblx0XHR0aGlzLkNvdW50ZXJEaXJlY3RpdmUuZmlyc3Quc3RhcnRUaW1lcigpO1xuXHRcdHRoaXMub25WYWx1ZUNoYW5nZS5lbWl0KC0yKTtcblx0fVxufSJdfQ==